# E16 服务器相关说明

## 服务器用途

E16服务器（58.206.101.40）主要给所有社员提供福利性质的校内VPS。同时通过podman容器提供社团百度网盘离线下载福利。

## 服务器概况

### 服务器硬件与系统

| 硬件 | 型号                                    |
|------|----------------------------------------|
| CPU  | AMD Ryzen 7 2700X Eight-Core Processor |
| 内存 | 2*16GB DDR4                            |
| 网卡 | RTL8111                                |
| 显卡 | NVIDIA GeForce GTX 750 Ti              |
| SSD  | 512GB                                  |
| HDD  | 4TB                                    |


其中SSD上安装了"Red Hat Enterprise Linux 8"发行版并托管了一部分VPS的磁盘镜像。考虑到未解决的历史遗留问题，HDD被分为4个分区，其中前654G挂载到`/data`目录，后面三个1T的分区分别挂载到dyt，zbc和zyb所处的虚拟机作为虚拟磁盘（待解决的历史遗留问题）。

### 服务器网络

E16服务器同时通过"教学区静态IP接入"（使用网卡`wan`，IP地址为`58.206.101.40`，受学校审查）和"教学区拨号接入"（使用由`macvlan`技术虚拟出来的网卡`eth1`，不受学校审查）的方式[接入校园网](http://git.ana/xjtuana/docs/src/branch/master/%E8%AF%B4%E6%98%8E%E6%96%87%E6%A1%A3/network.md#%E7%BD%91%E7%BB%9C%E6%8E%A5%E5%85%A5%E6%83%85%E5%86%B5)。在默认情况下，E16服务器上的软件会使用"教学区静态IP接入"出口来与互联网进行通讯。

## 虚拟机管理

拥有E16服务器权限的人（通常是部长或社长）需要通过服务器暴露的[libvirt接口](https://libvirt.org/)来管理服务器上的所有VPS，其链接信息为：`qemu+ssh://zbc@58.206.101.40/system`。社团推荐使用图形化管理工具，如[virt-manager](https://virt-manager.org/)来管理。

### 虚拟机网络

在E16服务器上的虚拟机一共有5种接入网络的方式，分别为"公网IP直接接入"，"自行拨号接入"，"静态nat接入"，"拨号nat接入"和"国际互联网nat接入"。虚拟机的每一张虚拟网卡对应一种接入模式。虚拟机可以自行选择安装一张或者更多张的虚拟网卡来同时接入不同种类的网络，但是虚拟机需要自己在内部确定路由方式。

#### 公网IP直接接入

由社团下发一个`58.206.101.41`到`58.206.101.46`（含）区间内的静态公网IP地址。该IP接入校园网的方式为"教学区静态IP接入"，因此无法在校外进行TCP访问，同时受审查。这种接入方式不提供IPv6地址。

使用上在创建虚拟机时需要将虚拟机的网卡桥接到`wan`网桥（选择"Bridge device"然后输入`wan`），然后在虚拟机内按照如下表格配置网络。

| 属性 | 值             |
|------|-----------------|
| IP   | 社团下发的IP/20 |
| 网关 | 58.206.96.1     |


#### 自行拨号接入

社团将使用该模式接入的网卡桥接到学校的教学区，虚拟机使用人需要自己在虚拟机内使用自己的教学区账户（通常为学号@stu和上网密码）来进行拨号。拨号后可以使用IPv4和IPv6，其中IPv4的TCP无法被校外访问。

使用上在创建虚拟机时需要将虚拟机的网卡桥接到`wan`网桥（选择"Bridge device"然后输入`wan`），然后在虚拟机内自行拨号。

#### 静态nat接入

由社团下发一个`192.168.254.0/24`段内的IP地址，虚拟机发出的报文通过SNAT传送到出口`58.206.101.40`。因为其本质为"教学区静态IP接入"，因此无法在校外进行TCP访问，无法使用IPv6，同时受审查。

使用上在创建虚拟机时需要将虚拟机的网卡配置到虚拟的`natvps`网络，然后在虚拟机内使用DHCP接受网络配置。

如果需要，可以在E16服务器上配置端口映射，具体来说需要联系管理员，然后在宿主机上运行以下命令：

```
firewall-cmd --direct --permanent --add-rule ipv4 nat PREROUTING 0 -d 58.206.101.40 -p tcp --dport <外部端口> -j DNAT --to-destination <你的虚拟机IP（位于192.168.254.0/24）>:<你需要映射的服务的内部端口>
firewall-cmd --reload
```

#### 拨号nat接入

由社团下发一个`192.168.253.0/24`段内的IP地址，虚拟机发出的报文通过SNAT传送到拨号出口。因为其本质为"教学区拨号接入"，因此无法在校外进行TCP访问，但是可以使用IPv6

使用上在创建虚拟机时需要将虚拟机的网卡配置到虚拟的`natvps-pppoe`网络，然后在虚拟机内使用DHCP接受网络配置。

如果需要，可以在E16服务器上配置端口映射，具体来说需要联系管理员，然后在宿主机上运行以下命令：

```
firewall-cmd --direct --permanent --add-rule ipv4 nat PREROUTING 0 -i ppp0 -p tcp --dport <外部端口> -j DNAT --to-destination <你的虚拟机IP（位于192.168.253.0/24）>:<你需要映射的服务的内部端口>
firewall-cmd --reload
```

#### 国际互联网nat接入

由社团下发一个`192.168.252.0/24`段内的IP地址，虚拟机发出的报文通过一些操作后直接送达到社团的HK出口，直接获得国际互联网访问。暂无法使用IPv6，不受审查，不进行接受端口映射（但是可以使用社团frp代替）。

使用上在创建虚拟机时需要将虚拟机的网卡配置到虚拟的`inet`网络，然后在虚拟机内使用DHCP接受网络配置。

